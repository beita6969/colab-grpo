# AFlow + ROLL é›†æˆè®­ç»ƒé…ç½®
# ğŸ”¥ P23ä¿®å¤: è®­ç»ƒç›®æ ‡å¯¹é½ - ä½¿ç”¨åŸå§‹DSLæ–‡æœ¬è€ŒéPythonä»£ç 
# æ ¹æœ¬åŸå› : ä¹‹å‰ä½¿ç”¨workflow_code(Pythonä»£ç )è®­ç»ƒï¼Œä½†promptè¦æ±‚ç”ŸæˆDSL
# è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨raw_text(åŸå§‹æ¨¡å‹è¾“å‡º)è¿›è¡Œè®­ç»ƒï¼Œä¿æŒè¾“å…¥è¾“å‡ºæ ¼å¼ä¸€è‡´
# ä¿®æ”¹æ—¶é—´: 2024-12-04

# å®éªŒé…ç½®
exp_name: "aflow_grpo_k2_b3_p30"  # P30: P29+é™ä½å­¦ä¹ ç‡10x(2e-5->2e-6)é˜²æ­¢ç¾éš¾æ€§é—å¿˜
output_dir: "checkpoints"
log_dir: "logs"
max_steps: 500
save_every: 50
eval_every: 999999
val_samples: 87
log_every: 5

# =====================================
# GRPOç®—æ³•é…ç½®ï¼ˆåŸºäºæ™ºèƒ½ä½“åˆ†æä¼˜åŒ–ï¼‰
# =====================================
adv_estimator: "grpo"
num_return_sequences_in_group: 2   # ğŸ”¥ P13ä¿®å¤: K=2 å‡å°‘å¹¶å‘(åŸK=4å¯¼è‡´è¶…æ—¶55%)
ppo_epochs: 1
async_generation_ratio: 0
use_kl_loss: true
kl_loss_coef: 0.005                # ğŸ”¥ P1ä¿®å¤: ä»0.011é™åˆ°0.005ï¼Œå‡å°‘KLæƒ©ç½šå…è®¸æ›´å¤šæ¢ç´¢
clip_range: 0.20                   # åŸºç¡€clip_range (å‘åå…¼å®¹)
clip_range_low: 0.2                # ğŸ”¥ P22 DAPO: ä¸‹ç•Œè£å‰ª (é™åˆ¶æ¦‚ç‡é™ä½)
clip_range_high: 0.28              # ğŸ”¥ P22 DAPO: ä¸Šç•Œè£å‰ª (æ”¾å®½æ¦‚ç‡æå‡ï¼Œé˜²æ­¢ç†µå´©æºƒ)
entropy_coef: 0.0                  # ğŸ”¥ P29: ç¦ç”¨ç†µå¥–åŠ± (åŸ0.01å¯¼è‡´æ¨¡å‹æ¼‚ç§»)
gamma: 1.0
lambda_gae: 0.95

# =====================================
# Batché…ç½®
# =====================================
rollout_batch_size: 3              # ğŸ”¥ P24ä¿®å¤: B=3 å‡å°‘OOM(åŸB=5), æ¯æ­¥6æ ·æœ¬
prompt_max_length: 3072
response_max_length: 4096          # ğŸ”¥ P24ä¿®å¤: ä»5120é™åˆ°4096ï¼Œå‡å°‘æ˜¾å­˜

# æ¨¡å‹é…ç½®
base_model: "/home/claude-user/models/Qwen2.5-7B-Instruct"  # æœ¬åœ°æ¨¡å‹è·¯å¾„
model_dtype: "bfloat16"

# =====================================
# LoRAé…ç½®
# =====================================
use_lora: true
lora_rank: 64
lora_alpha: 64
lora_target_modules: "q_proj,k_proj,v_proj,o_proj"
lora_dropout: 0.05

# =====================================
# è®­ç»ƒå‚æ•°ï¼ˆåŸºäºæ™ºèƒ½ä½“åˆ†æä¼˜åŒ–ï¼‰
# =====================================
learning_rate: 2.0e-6              # ğŸ”¥ P30ä¿®å¤: é™ä½10x(2e-5->2e-6)é˜²æ­¢ç¾éš¾æ€§é—å¿˜
weight_decay: 0.01
max_grad_norm: 1.0                 # ğŸ”¥ P1ä¿®å¤: ä»0.5æå‡åˆ°1.0ï¼Œå…è®¸æ›´å¤§æ¢¯åº¦
gradient_accumulation_steps: 8     # ğŸ”§ P24 OOMä¿®å¤: å¢åŠ åˆ°8ï¼Œå‡å°‘æ˜¾å­˜å³°å€¼
warmup_steps: 100                  # ğŸ”¥ P1ä¿®å¤: ä»50å¢åŠ åˆ°100ï¼ˆ20%è®­ç»ƒæ­¥æ•°ï¼‰
bf16: true
gradient_checkpointing: true       # ğŸ”§ OOMä¿®å¤: å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹

# GPUé…ç½®
device_mapping: [0]
physical_gpus: [0]  # A100 single GPU
protected_pids: []
num_gpus: 1
world_size: 1

# æ•°æ®é›†é…ç½®
data_dir: "data"
train_dataset: "data/ready_to_train/train_10k_final.jsonl"
val_dataset: "data/ready_to_train/test_500_preprocessed.jsonl"
test_dataset: "data/ready_to_train/test_500_preprocessed.jsonl"

# æ··åˆé‡‡æ ·æ¯”ä¾‹ (2:2:2 å‡åŒ€åˆ†å¸ƒ)
domain_ratios:
  math: 0.333
  code: 0.333
  qa: 0.334

# AFlowé…ç½®
aflow_config_path: "config/aflow_llm.yaml"
aflow_executor_model: "gpt-4o-mini"  # ä½¿ç”¨OpenAI API
aflow_operators: ["Custom", "AnswerGenerate", "Programmer", "ScEnsemble", "Test", "Review", "Revise"]
aflow_operator_descriptions_path: "config/operator.json"  # ä½¿ç”¨æœ¬åœ°è·¯å¾„
execution_timeout: 600

# =====================================
# å¥–åŠ±é…ç½®ï¼ˆä¿æŒåŸå€¼ï¼‰
# =====================================
reward_weights:
  correctness: 0.65
  efficiency: 0.15
  simplicity: 0.10
  format: 0.05
  repetition: 0.05

# æç¤ºè¯ä¼˜åŒ–ç³»ç»Ÿ
experience_buffer:
  enabled: true
  buffer_size: 100
  reward_threshold: 8.0
  persistence_dir: "data/experience_buffer"

prompt_optimizer:
  enabled: false  # ğŸ”§ ä¿®å¤: ç¦ç”¨ä»¥ä½¿ç”¨XMLæ ¼å¼prompt
  few_shot_k: 3
  similarity_threshold: 0.7

operator_prompt_enhancer:
  enabled: true
  top_k_examples: 2

# ç›‘æ§é…ç½®
wandb:
  enabled: false  # ç¦ç”¨wandb
  project: "agent-prompt"
  entity: "yao110002-sdfsdfsdfsdf-com"
  api_key: ""
  run_name: null

# =====================================
# Temperatureè°ƒåº¦ï¼ˆå¯ç”¨åŠ¨æ€æ¢ç´¢ï¼‰
# =====================================
temperature_schedule:
  enabled: true                    # ğŸ”¥ P1ä¿®å¤: å¯ç”¨æ¸©åº¦è°ƒåº¦
  initial: 0.3                     # ğŸ”¥ P19ä¿®å¤: ä»0.4é™åˆ°0.3ï¼Œå‡å°‘operatorå¹»è§‰
  final: 0.15                      # ğŸ”¥ P19ä¿®å¤: ä»0.2é™åˆ°0.15ï¼Œæ›´ç¨³å®šçš„è¾“å‡º
  warmup_steps: 100                # ğŸ”¥ P15ä¿®å¤: ä»150é™åˆ°100ï¼Œæ›´å¿«è¿›å…¥ç¨³å®šæœŸ

# =====================================
# ç”Ÿæˆé…ç½®
# =====================================
generation_config:
  temperature: 0.3                 # ğŸ”¥ P19ä¿®å¤: ä¸schedule.initialä¿æŒä¸€è‡´
  top_p: 0.90                      # ğŸ”¥ P19ä¿®å¤: ä»0.92é™åˆ°0.90ï¼Œè¿›ä¸€æ­¥æ”¶ç´§é‡‡æ ·
  top_k: 35                        # ğŸ”¥ P19ä¿®å¤: ä»40é™åˆ°35ï¼Œå‡å°‘é•¿å°¾é‡‡æ ·
  max_new_tokens: 4096
  do_sample: true

# è°ƒè¯•é€‰é¡¹
debug: true
verbose: true

# =====================================
# WA-GRPOé…ç½®ï¼ˆWorkflow-Awareä¼˜åŠ¿è®¡ç®—ï¼‰
# =====================================
wa_grpo:
  alpha: 0.12                        # tie-breakeræ··åˆç³»æ•°
  diversity_weight: 0.35             # å¤šæ ·æ€§æƒé‡
  revise_gain_weight: 0.25           # æ”¹è¿›å¹…åº¦æƒé‡
  exec_success_weight: 0.20          # æ‰§è¡ŒæˆåŠŸåº¦æƒé‡
  efficiency_weight: 0.10            # æ•ˆç‡æƒé‡
  op_variety_weight: 0.10            # Operatorå¤šæ ·æ€§æƒé‡
  min_advantage_std: 0.10            # æœ€å°ä¼˜åŠ¿æ ‡å‡†å·®
  batch_calibration: true            # æ‰¹å†…æ ¡å‡†
